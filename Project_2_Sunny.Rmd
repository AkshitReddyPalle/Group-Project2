---
title: "Project-6101"
author: "Sunny"
date: "2024-11-29"
output: 
  html_document:
    code_folding: show
    toc: yes
    toc_depth: 3
    toc_float: yes
---
```{r init, include=FALSE}
library(ezids)
library(dplyr)
library(ggplot2)
library(corrplot)
library(car)
```




```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = F, message = F, results = "markup")
options(scipen=999, digits = 5) 
```

# Data


```{r}
data_raw <- read.csv("C:/Users/qluo/Box/DATS 6101/Group-Project2/Combined_SDOH_2019_2020.csv")
```

```{r}
col_indices <- c('ACS_PCT_FEMALE','ACS_PCT_AGE_15_17','ACS_PCT_AGE_18_29','ACS_PCT_AGE_30_44',
                 'ACS_PCT_AIAN_NONHISP','ACS_PCT_ASIAN_NONHISP',
                 'ACS_PCT_BLACK_NONHISP',
                 'ACS_PCT_HISPANIC','ACS_PCT_NHPI_NONHISP','ACS_PCT_OTHER_NONHISP',
                 'ACS_PCT_NOT_LABOR','ACS_MEDIAN_HH_INC','ACS_PCT_HEALTH_INC_BELOW137',
                 'AHRF_UNEMPLOYED_RATE','AHRF_NURSE_MIDWIVES_RATE','CDCW_MATERNAL_DTH_RATE',
                 'POS_MEDIAN_DIST_OBSTETRICS','POS_FQHC_RATE',
                 'POS_HOSP_OBSTETRIC_RATE','POS_HOSP_MEDSURG_ICU_RATE','POS_HOSP_ED_RATE','POS_PCT_HOSP_GOV')
 
subset_data <- data_raw[,col_indices]
colnames(subset_data) <- c('Percent_femal_pop',"Percent_pop_15_17","Percent_pop_18_29","Percent_pop_30_44",
                           'Percent_pop_American_Indian_and_Alaska_Native','Percent_pop_Asian',
                           'Percent_pop_Black_and_African_American','Percent_pop_Hispanic',
                           'Percent_pop_Native_Hawaiian_and_Pacific_Islander','Percent_pop_other_race',
                           "Percent_pop_not_in_labor_force_16",'Median_household_income',
                           'Percent_pop_under_1.37_of_poverty_threshold',
                           "Unemployment_rate_per_100_population_16",
                           'Number_of_midwives','Maternal_mortality_rate',
                           'Median_distance_to_nearest_obstetrics_department','Numer_of_health_centers',
                           'Number_of_hospitals_with_obstetric','Number_of_hospitals_with_ICU',
                           'Number_of_hospitals_with_emergency_department','Percent_government_hospitals')

```
Considering adding a table to show the variable names and variable labels,or we can divide the variables into different categories, making them clear.

```{r}
subset_data$Maternal_mortality_rate[is.na(subset_data$Maternal_mortality_rate)] <- 0

```

```{r}
sum(complete.cases(subset_data))
subset_data <- na.omit(subset_data)
```

```{r}
model <- lm(Maternal_mortality_rate ~ ., data=subset_data)
summary(model)
```
```{r}
vif_values <- vif(model)
print(vif_values)

```
The VIF values are relatively high for `Median_household_income` and `Percent_pop_under_1.37_of_poverty_threshold`. Doing the corelation test to check the multicolinearity.    

```{r}
#Pearson correlation (default)
cor.test(subset_data$Median_household_income, subset_data$Percent_pop_under_1.37_of_poverty_threshold, method = "pearson")

# Spearman correlation
cor.test(subset_data$Median_household_income, subset_data$Percent_pop_under_1.37_of_poverty_threshold, method = "spearman")

```
The coefficients for the two variables are higher than 0.8. Drop `Median_household_income` and run the model 
```{r}
# Fit a model excluding Median_household_income
model_1 <- lm(Maternal_mortality_rate ~ . - Percent_pop_under_1.37_of_poverty_threshold, data = subset_data)

# View summary
summary(model_1)

```




```{r}
# Fit a Tree-Based Model
library(randomForest)
set.seed(123)
rf_model <- randomForest(
  Maternal_mortality_rate ~ .,
  data = subset_data,
  ntree=500,
  importance=TRUE
  )


```

```{r}
rf_model

```
```{r}
library(caret)
# Split the data into training and test sets
train_index <- createDataPartition(subset_data$Maternal_mortality_rate, p = 0.8, list = FALSE)
train_data <- subset_data[train_index, ]
test_data <- subset_data[-train_index, ]
# Define the tuning grid with mtry
tune_grid <- expand.grid(
  mtry = c(2, 4, 6, 8)  # Range of mtry values to test
)
# Model Tuning on Training Data 
tuned_model <- train(
  Maternal_mortality_rate ~ ., 
  data = train_data, 
  method = "rf", 
  tuneGrid = tune_grid, 
  trControl = trainControl(method = "cv", number = 5)
)
# Evaluate the tuned model on the test set
predicted <- predict(tuned_model, newdata = test_data)
rmse <- sqrt(mean((predicted - test_data$Maternal_mortality_rate)^2))
print(paste("RMSE on test data:", rmse))

```
```{r}
# Predict on the test set
predicted <- predict(tuned_model, newdata = test_data)

# Calculate RMSE (Root Mean Squared Error)
rmse <- sqrt(mean((predicted - test_data$Maternal_mortality_rate)^2))
cat("RMSE on test data:", rmse, "\n")

# Calculate R-squared
rsq <- 1 - sum((predicted - test_data$Maternal_mortality_rate)^2) /
             sum((mean(test_data$Maternal_mortality_rate) - test_data$Maternal_mortality_rate)^2)
cat("R-squared on test data:", rsq, "\n")

```




```{r}
# Extract the best hyperparameters
best_mtry <- tuned_model$bestTune$mtry  # Best mtry from tuning

# Refit the final model on the entire dataset
final_model <- randomForest(
  Maternal_mortality_rate ~ .,
  data = subset_data,  # Use the entire dataset
  ntree = 500,         # Use the best ntree (default is 500)
  mtry = best_mtry,    # Use the tuned mtry
  importance = TRUE
)

# Print the final model summary
print(final_model)

```



```{r}
# Extract the importance matrix
importance_metrics <- importance(final_model)

# Sort by `%IncMSE`
sorted_by_mse <- importance_metrics[order(-importance_metrics[, "%IncMSE"]), ]

# View the sorted matrix
print(sorted_by_mse)
```


The column `%IncMSE` stands for percentage increase in Mean Squared Error.
Measures how much the modelâ€™s prediction error increases when a particular variable is randomly permuted while keeping all other variables unchanged..
Higher values indicate that the variable is important for the model's predictive accuracy.It reflects the variable's contribution to the overall model performance.
The column `IncNodePurity` stands for Increase in Node Purity.
Reflects the total decrease in node impurity (measured by RSS for regression or Gini index for classification) attributed to splits involving this variable.
Higher values suggest that the variable contributes significantly to better node splits.

```{r}
# Adjust margins for longer labels
par(mar = c(10, 5, 2, 2))  # Increase bottom margin

# Bar plot with adjusted margins
barplot(sorted_by_mse[, "%IncMSE"],
        names.arg = rownames(sorted_by_mse),
        las = 2,
        col = "skyblue",
        main = "Variable Importance by %IncMSE",
        ylab = "%IncMSE",
        cex.names = 0.5)
```


Socioeconomic Factors

The coefficients for `Percent_pop_Black_and_African_American`, `Percent_pop_Asian`, and `Percent_pop_Hispanic` are positive and significant, suggesting that a higher percentage of these racial populations is associated with increased maternal mortality. This highlights the impact of systemic inequities and potential disparities in healthcare access.

Solution:

Address racial disparities by improving access to healthcare for minority populations.
Implement culturally tailored maternal health programs to meet the specific needs of these communities.
Invest in training healthcare providers to ensure culturally competent and bias-free care.

Demographic Trends

The coefficients for `Percent_pop_30_44` and `Percent_femal_pop` are positive and highly significant, while the coefficients for `Percent_pop_15_17` and `Percent_pop_18_29` are significantly negative. This indicates that counties with a higher percentage of women aged 30-44 experience higher maternal mortality rates. It suggests that earlier pregnancies may reduce maternal mortality risks.

Solution:

Provide policy support to enable younger women to start families, such as affordable childcare, flexible work arrangements, and enhanced parental leave policies.
Raise awareness of the potential risks of delayed childbearing and provide comprehensive prenatal care for older mothers.

Healthcare Access

The coefficient for `Median_distance_to_nearest_obstetrics_department` is negative and highly significant, indicating that greater distances to obstetric care facilities are associated with higher maternal mortality rates. Similarly, the coefficients for `Number_of_hospitals_with_obstetric` and `Percent_government_hospitals` are negative and significant, suggesting that increasing the number of hospitals with obstetric departments or government hospitals reduces maternal mortality.

Solution:

Expand access to obstetric care facilities in underserved areas.
Build or upgrade healthcare infrastructure in regions lacking obstetric and maternal care services.
Encourage partnerships between public and private sectors to fund and establish obstetric departments in existing hospitals.

Economic Disparities

The coefficient for `Median_household_income` is negative and significant, while the coefficient for `Unemployment_rate_per_100_population_16` is positive and significant. These findings indicate that counties with higher income levels and lower unemployment rates tend to have lower maternal mortality.

Solution:

Strengthen socioeconomic support for low-income and unemployed populations.
Expand access to healthcare subsidies, prenatal care programs, and financial assistance for underserved communities.
Implement workforce development programs to reduce unemployment and improve economic stability in high-risk counties.
